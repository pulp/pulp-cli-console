import click
from pulp_glue.common.context import PulpContext
from pulp_glue.console.context import PulpVulnerabilityReportContext

from pulpcore.cli.common.generic import (
    PulpCLIContext,
    chunk_size_option,
    create_command,
    destroy_command,
    href_option,
    list_command,
    pass_entity_context,
    pass_pulp_context,
    show_command,
)


def attach_vulnerability_commands(console_group):
    @console_group.group()
    @pass_pulp_context
    @click.pass_context
    def vulnerability(ctx: click.Context, pulp_ctx: PulpContext, /) -> None:
        """Manage vulnerability reports."""
        ctx.obj = PulpVulnerabilityReportContext(pulp_ctx)

    lookup_options = [href_option]

    # Add commands to the vulnerability group
    vulnerability.add_command(list_command())
    vulnerability.add_command(show_command(decorators=lookup_options))
    vulnerability.add_command(destroy_command())
    vulnerability.add_command(create_command())

    @vulnerability.command()
    @click.option(
        "--file", type=click.File("rb"), required=True, help="JSON file containing npm packages"
    )
    @chunk_size_option
    @pass_entity_context
    @pass_pulp_context
    def upload(
        pulp_ctx: PulpCLIContext,
        vulnerability_ctx: PulpVulnerabilityReportContext,
        /,
        file: click.File,
        chunk_size: int,
    ) -> None:
        """Upload a vulnerability report JSON file."""
        result = vulnerability_ctx.upload(file, chunk_size)
        pulp_ctx.output_result(result)
